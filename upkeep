#!/bin/bash
# Copyright 2015 Foursquare Labs Inc. All Rights Reserved.

# Pass variables to children
set -ea

# Only try to redefine BUILD_ROOT if this is being used as the entry point.
[ -z "${BUILD_ROOT+x}" ] && BUILD_ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

DEPENDENCIES_ROOT="${BUILD_ROOT}/dependencies"
UPKEEPROOT="${BUILD_ROOT}/scripts/fsqio/upkeep"
mkdir -p "${DEPENDENCIES_ROOT}"

# Use the presence of the 'scripts/foursquare' folder to determine if we are in in Fsq.io repo.
if [[ -e "scripts/foursquare" ]]; then
  ENV_FILE='scripts/foursquare/upkeep/env.sh'
else
  ENV_FILE="${UPKEEPROOT}/env.sh"
fi

# Symlink the proper environmental variables script to the buildroot.
ln -sf "${ENV_FILE}" environ.sh
source environ.sh
source "${UPKEEPROOT}/util.sh"

# TODO(mateo): add an option to list downstream tasks.
case "$1" in
  "help"|"--help"|"-h" )
    print_help
    exit
    ;;
  "force"|"check" )
    action="$1"
    args=( "${@:2}" )
    ;;
  '')
    action='check'
    args=()
    ;;
  "tasks" )
    print_all_tasks
    exit
    ;;
  "task-list" )
    all_task_names
    exit
    ;;
  *)
    action='run'
    args=( "${@:1}" )
    ;;
esac

[ ! -z "${action+x}" ] && exec "${UPKEEPROOT}/${action}.sh" "${args[@]}"
